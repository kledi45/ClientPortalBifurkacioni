@{
    ViewData["Title"] = "Kyçu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container py-5">
    <div id="message" class="mb-3"></div>

    <div class="row justify-content-center align-items-stretch">
        <div class="col-md-6 d-flex align-items-stretch">
            <div class="bg-white p-4 rounded shadow-sm w-100 d-flex flex-column justify-content-center">
                <h3 class="text-center fw-bold">e-Bifurkacioni</h3>
                <p class="text-center text-muted">
                    Me e-Bifurkacionin ju mund t’i shihni të gjitha transaksionet e bëra,<br />
                    faturat e pranuara, bilancin tuaj aktual, kalkulatorin e ujit dhe<br />
                    të merrni shumë shërbime të tjera të rëndësishme për ju.
                </p>
                <div class="d-flex justify-content-center align-items-center gap-2 mt-3 store-badges">
                    <img src="~/images/Google_Play_Store_Badge.svg" alt="Google Play" class="store-img" />
                    <img src="~/images/Download_on_the_App_Store_Badge.svg" alt="App Store" class="store-img" />
                </div>
            </div>
        </div>

        <div class="col-md-6 d-flex align-items-stretch">
            <div class="bg-white p-4 rounded shadow-sm w-100">
                <ul class="nav nav-tabs justify-content-center flex-wrap text-center mb-3" id="authTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Kyçu</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">Regjistrohu</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pay-tab" data-bs-toggle="tab" data-bs-target="#pay" type="button" role="tab">Pagesa direkte</button>
                    </li>
                </ul>

                <div class="tab-content" id="authTabsContent">
                    <!-- Login -->
                    <div class="tab-pane fade show active" id="login" role="tabpanel">
                        <form id="login-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="email" placeholder="Llogaria/Email Adresa" />
                            </div>
                            <div class="mb-3">
                                <input type="password" class="form-control" name="password" placeholder="Fjalëkalimi" />
                            </div>
                            <div class="mb-3 text-end">
                                <a href="#" class="text-primary small">Rikrijo fjalëkalimin</a>
                            </div>
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary">Kyçu</button>
                            </div>
                            <select class="form-select">
                                <option selected>Shqip</option>
                                <option>English</option>
                            </select>
                        </form>
                    </div>

                    <!-- Register -->
                    <div class="tab-pane fade" id="register" role="tabpanel">
                        <!-- Account Type Modal Trigger -->
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#accountTypeModal">
                                Zgjidhni llojin e llogarisë
                            </button>
                        </div>

                        <!-- Modal -->
                        <div class="modal fade" id="accountTypeModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content text-center p-4">
                                    <h5 class="mb-3">Ju lutem zgjidhni llojin e llogarisë</h5>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="selectAccountType('individual')">Individuale</button>
                                        <button type="button" class="btn btn-primary" onclick="selectAccountType('business')">Biznesore</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Register Form -->
                        <form id="register-form">
                            <input type="hidden" name="accountType" id="accountType" value="" />

                            <div id="individual-form" style="display:none;">
                                <div class="mb-2"><input type="text" class="form-control" name="firstName" placeholder="Emri*" /></div>
                                <div class="mb-2"><input type="text" class="form-control" name="lastName" placeholder="Mbiemri*" /></div>
                                <div class="mb-2"><input type="text" class="form-control" name="phoneNumber" placeholder="Numri i telefonit*" value="+383" /></div>
                                <div class="mb-2"><input type="email" class="form-control" name="registerEmail" placeholder="E-Mail*" /></div>
                                <div class="mb-2"><input type="password" class="form-control" name="registerPassword" placeholder="Vendos fjalëkalimin*" /></div>
                                <div class="mb-2"><input type="password" class="form-control" name="confirmPassword" placeholder="Përsërit fjalëkalimin*" /></div>
                                <div class="mb-3"><input type="text" class="form-control" name="personalNumber" placeholder="Numri personal*" /></div>
                            </div>

                            <div id="business-form" style="display:none;">
                                <div class="mb-2"><input type="text" class="form-control" name="businessName" placeholder="Emri i biznesit*" /></div>
                                <div class="mb-2"><input type="text" class="form-control" name="phoneNumber" placeholder="Numri i telefonit*" value="+383" /></div>
                                <div class="mb-2"><input type="email" class="form-control" name="businessRegisterEmail" placeholder="E-Mail*" /></div>
                                <div class="mb-2"><input type="password" class="form-control" name="businessRegisterPassword" placeholder="Vendos fjalëkalimin*" /></div>
                                <div class="mb-2"><input type="password" class="form-control" name="businessConfirmPassword" placeholder="Përsërit fjalëkalimin*" /></div>
                                <div class="mb-2"><input type="text" class="form-control" name="businessPersonalNumber" placeholder="Numri personal*" /></div>
                                <div class="mb-3"><input type="text" class="form-control" name="nui" placeholder="Numri unik identifikues (NUI)*" /></div>
                            </div>

                            <div class="text-center small mb-3">
                                Duke vazhduar, ju gjithashtu pajtoheni me
                                <a href="/PrivacyPolicy/Index?language=sq" target="_blank">Kushtet e shërbimit dhe Politikën e privatësisë</a>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Regjistrohu</button>
                            </div>
                        </form>
                    </div>

                    <!-- Direct Payment -->
                    <div class="tab-pane fade" id="pay" role="tabpanel">
                        <form id="pay-form">
                            <div class="d-flex justify-content-center align-items-center gap-2 mb-3 payment-badges">
                                <img src="~/images/visa.svg" alt="Visa" class="payment-img" />
                                <img src="~/images/masterCard.svg" alt="MasterCard" class="payment-img" />
                            </div>
                            <p>
                                Këtu bëhen pagesat e drejtpërdrejta të faturave të ujit të shpenzuar, pa pasur
                                nevojë të hapni llogari për të pranuar këtë shërbim.
                            </p>
                            <p>
                                Shënoni shifrën tuaj të konsumatorit si dhe të dhënat tuaja bankare (kartela Visa ose MasterCard) për të vazhduar tutje.
                            </p>
                            <div class="mb-3">
                                <input type="text" class="form-control" name="customerCode" placeholder="Shifra e konsumatorit" />
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Kërko konsumatorin</button>
                            </div>
                        </form>
                        <div id="payment-info" style="display:none;">
                            <p><strong>Emri i konsumatorit:</strong> <span id="customerName">-</span></p>
                            <p><strong>Fatura e fundit:</strong> <span id="lastBillAmount">-</span> €</p>
                            <p><strong>Faturuar më:</strong> <span id="lastBillDate">-</span></p>
                            <p><strong>Pagesa e fundit:</strong> <span id="lastPaymentAmount">-</span> €</p>
                            <p><strong>Paguar më:</strong> <span id="lastPaymentDate">-</span></p>
                            <p><strong>Borxhi total:</strong> <span id="totalDebt">-</span> €</p>

                            <div class="mb-2">
                                <input type="email" class="form-control" name="paymentEmail" placeholder="Email Adresa" />
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" name="paymentPhone" placeholder="Numri Telefonik" />
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" name="paymentAmount" placeholder="Shuma për pagesë" />
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" value="" id="acceptPolicy" />
                                <label class="form-check-label" for="acceptPolicy">
                                    Pajtohem me <a href="/PrivacyPolicy/Index?language=sq" target="_blank">Kushtet dhe Termet e Përgjithshme</a>
                                </label>
                            </div>
                            <div class="d-grid mt-2">
                                <button type="button" class="btn btn-primary" id="payNowBtn">Paguaj</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div class="modal fade" id="verifyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="mb-3">Verifikoni llogarinë tuaj</h5>
      <p>Ju lutem vendosni kodin 6-shifror që ju është dërguar.</p>
      <div id="timer" class="mb-2 text-danger fw-bold"></div>
      <input type="text" id="verificationCode" maxlength="6" class="form-control mb-2" placeholder="Kodi 6-shifror" autocomplete="one-time-code" />
      <div id="verifyError" class="text-danger mb-2" style="display:none;"></div>
      <button id="verifyBtn" class="btn btn-primary w-100 mb-2">Verifiko</button>
    </div>
  </div>
</div>

<script>
    function setupRegisterValidation(accountType) {
        // Remove any previous validator
        if ("#register-form" && $("#register-form").data('validator')) {
            $("#register-form").validate().destroy();
        }

        let rules = {}, messages = {};

        if (accountType === "individual") {
            rules = {
                accountType: { required: true },
                firstName: { required: true },
                lastName: { required: true },
                phoneNumber: { required: true },
                registerEmail: { required: true, email: true },
                registerPassword: { required: true, minlength: 6 },
                confirmPassword: { required: true, equalTo: "[name='registerPassword']" },
                personalNumber: { required: true }
            };
            messages = {
                accountType: '<li class="parsley-required">Zgjedhja e llogarisë është e detyrueshme</li>',
                firstName: '<li class="parsley-required">Emri është i detyrueshëm</li>',
                lastName: '<li class="parsley-required">Mbiemri është i detyrueshëm</li>',
                phoneNumber: '<li class="parsley-required">Numri i telefonit është i detyrueshëm</li>',
                registerEmail: '<li class="parsley-required">Email-i është i detyrueshëm</li>',
                registerPassword: '<li class="parsley-required">Fjalëkalimi është i detyrueshëm (min 6 karaktere)</li>',
                confirmPassword: '<li class="parsley-required">Fjalëkalimi nuk përputhet</li>',
                personalNumber: '<li class="parsley-required">Numri personal është i detyrueshëm</li>'
            };
        } else if (accountType === "business") {
            rules = {
                accountType: { required: true },
                businessName: { required: true },
                phoneNumber: { required: true },
                businessRegisterEmail: { required: true, email: true },
                businessRegisterPassword: { required: true, minlength: 6 },
                businessConfirmPassword: { required: true, equalTo: "[name='businessRegisterPassword']" },
                businessPersonalNumber: { required: true },
                nui: { required: true }
            };
            messages = {
                accountType: '<li class="parsley-required">Zgjedhja e llogarisë është e detyrueshme</li>',
                businessName: '<li class="parsley-required">Emri i biznesit është i detyrueshëm</li>',
                phoneNumber: '<li class="parsley-required">Numri i telefonit është i detyrueshëm</li>',
                businessRegisterEmail: '<li class="parsley-required">Email-i është i detyrueshëm</li>',
                businessRegisterPassword: '<li class="parsley-required">Fjalëkalimi është i detyrueshëm (min 6 karaktere)</li>',
                businessConfirmPassword: '<li class="parsley-required">Fjalëkalimi nuk përputhet</li>',
                businessPersonalNumber: '<li class="parsley-required">Numri personal është i detyrueshëm</li>',
                nui: '<li class="parsley-required">NUI është i detyrueshëm</li>'
            };
        }

        $("#register-form").validate({
            ignore: [],
            rules: rules,
            messages: messages,
            submitHandler: function (form) {
                const accountType = $("#accountType").val();
                let registerData = { AccountType: accountType };

                if (accountType === "individual") {
                    registerData.FirstName = $("input[name='firstName']").val();
                    registerData.LastName = $("input[name='lastName']").val();
                    registerData.PhoneNumber = $("input[name='phoneNumber']").val();
                    registerData.Email = $("input[name='registerEmail']").val();
                    registerData.Password = $("input[name='registerPassword']").val();
                    registerData.ConfirmPassword = $("input[name='confirmPassword']").val();
                    registerData.PersonalNumber = $("input[name='personalNumber']").val();
                } else if (accountType === "business") {
                    registerData.BusinessName = $("input[name='businessName']").val();
                    registerData.PhoneNumber = $("input[name='phoneNumber']").val();
                    registerData.Email = $("input[name='businessRegisterEmail']").val();
                    registerData.Password = $("input[name='businessRegisterPassword']").val();
                    registerData.ConfirmPassword = $("input[name='businessConfirmPassword']").val();
                    registerData.PersonalNumber = $("input[name='businessPersonalNumber']").val();
                    registerData.NUI = $("input[name='nui']").val();
                }

                Post(registerData, '/Auth/Register').done(function (res) {
                    if (res.success) {
                        verificationUserId = res.userId; // Store the returned userId for now
                        $('#verifyModal').modal({ backdrop: 'static', keyboard: false });
                        startVerificationTimer(5 * 60); // 5 minutes
                    } else {
                        showAlert(res.message, 'message', 'danger');
                    }
                });

                return false;
            }
        });
    }

    let verificationUserId = null;
    let verificationInterval = null;
    function startVerificationTimer(seconds) {
        clearInterval(verificationInterval);
        let remaining = seconds;
        updateTimerDisplay(remaining);
        $('#verifyBtn').prop('disabled', false);
        verificationInterval = setInterval(function() {
            remaining--;
            updateTimerDisplay(remaining);
            if (remaining <= 0) {
                clearInterval(verificationInterval);
                $('#verifyBtn').prop('disabled', true);
                $('#timer').text('Koha për verifikim ka skaduar.');
            }
        }, 1000);
    }
    function updateTimerDisplay(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        $('#timer').text(`Koha e mbetur: ${min}:${sec.toString().padStart(2, '0')}`);
    }

    $(document).ready(function () {
        // Login form validation and submission
        $("#login-form").validate({
            rules: {
                email: { required: true, email: true },
                password: { required: true }
            },
            messages: {
                email: '<li class="parsley-required">Te plotesohet email-i</li>',
                password: '<li class="parsley-required">Te plotesohet fjalëkalimi</li>'
            },
            submitHandler: function (form) {
                const data = $(form).serialize();

                // Clear any previous visual errors
                $("[name='email']").removeClass("is-invalid");
                $("[name='password']").removeClass("is-invalid");

                Post(data, '/Auth/Login').done(function (res) {
                    if (res.success) {
                        location.href = "Home/Index"
                    } else {
                        showAlert(res.message, 'message', 'danger');

                        // Visual feedback per backend message
                        if (res.message.toLowerCase().includes("email")) {
                            $("[name='email']").addClass("is-invalid");
                        } else if (res.message.toLowerCase().includes("fjalëkalimi")) {
                            $("[name='password']").addClass("is-invalid");
                        }
                    }
                });

                return false;
            }
        });

        // Initialize with no account type (or default to individual if you prefer)
        setupRegisterValidation("");

        // Direct Payment form
        $("#pay-form").validate({
            rules: {
                customerCode: { required: true }
            },
            messages: {
                customerCode: '<li class="parsley-required">Shifra e konsumatorit është e detyrueshme</li>'
            },
            submitHandler: function (form) {
                const code = $("[name='customerCode']").val();
                Post({}, `/Public/GetCustomerBill?CustomerCode=${code}`).done(function (res) {
                    if (res.success) {
                        const d = res.data;
                        $("#payment-info").show();
                        $("#customerName").text(d.customerName || "-");
                        $("#lastBillAmount").text(d.lastBillAmount?.toFixed(2) || "0.00");
                        $("#lastBillDate").text(d.lastBillDate || "-");
                        $("#lastPaymentAmount").text(d.lastPaymentAmount?.toFixed(2) || "0.00");
                        $("#lastPaymentDate").text(d.lastPaymentDate || "-");
                        $("#totalDebt").text(d.totalDebt?.toFixed(2) || "0.00");
                        $("[name='paymentAmount']").val(d.totalDebt?.toFixed(2) || "0.00");
                    } else {
                        showAlert(res.message || "Nuk u gjet asnjë konsumator me këtë kod.", 'message', 'danger');
                        $("#payment-info").hide();
                    }
                });

                return false;
            }
        });

        // Attach handler for verify button
        $('#verifyBtn').off('click').on('click', function() {
            const code = $('#verificationCode').val().trim();
            $('#verifyError').hide();
            if (!/^[0-9]{6}$/.test(code)) {
                $('#verifyError').text('Ju lutem vendosni një kod të vlefshëm 6-shifror.').show();
                return;
            }
            // For now, just show a success message (simulate backend call)
            // Replace this with your actual verification AJAX call later
            $('#verifyModal').modal('hide');
            showAlert('Kodi u pranua (simulim)!', 'message', 'success');
        });
    });
    $("#payNowBtn").click(function () {
        const emailValid = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test($("[name='paymentEmail']").val().trim());
        const phoneValid = $("[name='paymentPhone']").val().trim() !== "";
        const amountValid = $("[name='paymentAmount']").val().trim() !== "";
        const policyAccepted = $("#acceptPolicy").is(":checked");

        let valid = true;

        if (!emailValid) {
            $("[name='paymentEmail']").addClass("is-invalid");
            valid = false;
        } else {
            $("[name='paymentEmail']").removeClass("is-invalid");
        }

        if (!phoneValid) {
            $("[name='paymentPhone']").addClass("is-invalid");
            valid = false;
        } else {
            $("[name='paymentPhone']").removeClass("is-invalid");
        }

        if (!amountValid) {
            $("[name='paymentAmount']").addClass("is-invalid");
            valid = false;
        } else {
            $("[name='paymentAmount']").removeClass("is-invalid");
        }

        if (!policyAccepted) {
            $("#acceptPolicy").addClass("is-invalid");
            $("#policyError").removeClass("d-none");
            valid = false;
        } else {
            $("#acceptPolicy").removeClass("is-invalid");
            $("#policyError").addClass("d-none");
        }

        if (!valid) {
            showAlert("Ju lutem plotësoni të gjitha fushat për pagesë me të dhëna të sakta dhe pranoni kushtet.", "message", "danger");
            return;
        }

        const data = {
            customerCode: $("[name='customerCode']").val(),
            email: $("[name='paymentEmail']").val(),
            phone: $("[name='paymentPhone']").val(),
            amount: $("[name='paymentAmount']").val()
        };

        Post(data, '/Public/SubmitPayment').done(function (res) {
            if (res.success && res.url) {
                window.location.href = res.url;
            } else {
                showAlert(res.message || "Pagesa dështoi.", 'message', 'danger');
            }
        });
    });

    function selectAccountType(type) {
        $("#accountType").val(type);
        $("#accountTypeModal").modal('hide');

        if (type === 'individual') {
            $("#individual-form").show();
            $("#business-form").hide();
        } else {
            $("#individual-form").hide();
            $("#business-form").show();
        }

        setupRegisterValidation(type); // Dynamically update validation
    }   
</script>

